<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>å¾‹å¸«è¨ˆæ™‚ç®¡ç†ç³»çµ±</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- Theme color (ç€è¦½å™¨ UI é¡è‰²) -->
  <meta name="theme-color" content="#1a3557" />
  <meta name="msapplication-TileColor" content="#1a3557" />

  <!-- iOS PWA æ”¯æ´ -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="å¾‹å¸«è¨ˆæ™‚" />
  <link rel="apple-touch-icon" href="icon.png" />

  <!-- Android / SEO -->
  <meta name="application-name" content="å¾‹å¸«è¨ˆæ™‚ç®¡ç†ç³»çµ±" />
  <meta name="description" content="å§”è¨—äººå°ˆæ¡ˆè¨ˆæ™‚ã€ç´¯è¨ˆè€—è²»æ™‚é–“åŠæˆªæ­¢æœŸé™æé†’å·¥å…·" />
  <meta name="mobile-web-app-capable" content="yes" />
  <style>
    :root {
      --primary: #1a3557;
      --primary-light: #2a4f7c;
      --accent: #c9a84c;
      --accent-light: #e2c476;
      --bg: #f0f2f5;
      --card: #ffffff;
      --text: #1a1a2e;
      --text-muted: #6b7280;
      --border: #d1d5db;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #d97706;
      --info: #0284c7;
      --radius: 12px;
      --shadow: 0 2px 16px rgba(26,53,87,0.10);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 40px;
    }
    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      padding: 18px 24px 14px;
      display: flex;
      align-items: center;
      gap: 14px;
      box-shadow: 0 2px 12px rgba(26,53,87,0.25);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header .logo { font-size: 28px; }
    header h1 { font-size: 1.25rem; font-weight: 700; letter-spacing: .02em; }
    header .subtitle { font-size: .75rem; opacity: .75; margin-top: 2px; }
    header .header-right { margin-left: auto; text-align: right; font-size: .75rem; opacity: .8; }
    #alertBanner {
      display: none;
      background: #fff3cd;
      border-left: 5px solid var(--warning);
      padding: 12px 20px;
      font-size: .9rem;
    }
    #alertBanner .alert-title { font-weight: 700; color: var(--warning); margin-bottom: 6px; }
    #alertBanner ul { padding-left: 20px; }
    #alertBanner li { margin-bottom: 4px; }
    .container { max-width: 960px; margin: 0 auto; padding: 20px 16px; }
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; background: var(--card); border-radius: var(--radius); padding: 5px; box-shadow: var(--shadow); flex-wrap: wrap; }
    .tab-btn {
      flex: 1; padding: 10px 8px; border: none; background: transparent;
      border-radius: 9px; font-size: .85rem; font-weight: 600; color: var(--text-muted);
      cursor: pointer; transition: all .2s; min-width: 60px;
    }
    .tab-btn.active { background: var(--primary); color: #fff; }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 16px; }
    .card-title {
      font-size: 1rem; font-weight: 700; color: var(--primary);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 8px; margin-bottom: 16px;
      display: flex; align-items: center; gap: 8px;
    }
    .form-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 14px; }
    .form-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 160px; }
    .form-group label { font-size: .8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .04em; }
    .form-group select, .form-group input[type="text"], .form-group input[type="date"], .form-group textarea {
      padding: 10px 12px; border: 1.5px solid var(--border); border-radius: 8px;
      font-size: .95rem; color: var(--text); background: #fff; transition: border-color .2s; width: 100%;
    }
    .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
      outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26,53,87,.12);
    }
    .form-group textarea { resize: vertical; min-height: 72px; }
    .timer-section {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: var(--radius); padding: 24px 20px; color: #fff; text-align: center;
      margin-bottom: 16px; box-shadow: var(--shadow);
    }
    .timer-display { font-size: 3rem; font-weight: 700; font-variant-numeric: tabular-nums; letter-spacing: .05em; }
    .timer-label { font-size: .8rem; opacity: .7; margin-top: 4px; text-transform: uppercase; letter-spacing: .1em; }
    .timer-cumulative { margin-top: 14px; padding-top: 14px; border-top: 1px solid rgba(255,255,255,.2); }
    .timer-cumulative .cum-label { font-size: .75rem; opacity: .7; }
    .timer-cumulative .cum-value { font-size: 1.6rem; font-weight: 700; }
    .timer-context { font-size: .85rem; opacity: .85; margin-top: 8px; }
    .btn {
      padding: 11px 20px; border-radius: 9px; border: none; font-size: .9rem; font-weight: 600;
      cursor: pointer; transition: all .18s; display: inline-flex; align-items: center; gap: 7px;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-light); }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-accent:hover { background: var(--accent-light); }
    .btn-success { background: var(--success); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-secondary { background: #16a34a; color: #fff; }
    .btn-secondary:hover { background: #15803d; }
    .btn-outline { background: transparent; border: 1.5px solid var(--border); color: var(--text); }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
    .btn-lg { padding: 14px 28px; font-size: 1.05rem; border-radius: 12px; width: 100%; justify-content: center; }
    .btn-sm { padding: 6px 12px; font-size: .78rem; border-radius: 6px; }
    .btn-start { background: linear-gradient(135deg, #16a34a, #15803d); color: #fff; font-size: 1.1rem; }
    .btn-stop  { background: linear-gradient(135deg, #dc2626, #b91c1c); color: #fff; font-size: 1.1rem; }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 99px; font-size: .75rem; font-weight: 600; }
    .badge-success { background: #dcfce7; color: #16a34a; }
    .badge-danger  { background: #fee2e2; color: #dc2626; }
    .badge-warning { background: #fef3c7; color: #d97706; }
    .badge-info    { background: #e0f2fe; color: #0284c7; }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: .875rem; }
    th { background: var(--primary); color: #fff; padding: 10px 12px; text-align: left; font-weight: 600; font-size: .8rem; letter-spacing: .03em; }
    th:first-child { border-radius: 8px 0 0 0; }
    th:last-child  { border-radius: 0 8px 0 0; }
    td { padding: 9px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #f8f9fa; }
    .deadline-ok     { color: var(--success); }
    .deadline-warn   { color: var(--warning); font-weight: 700; }
    .deadline-danger { color: var(--danger);  font-weight: 700; }
    .list-items { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .list-item { display: inline-flex; align-items: center; gap: 6px; background: #f3f4f6; border-radius: 99px; padding: 5px 12px; font-size: .85rem; }
    .list-item .del-btn { background: none; border: none; cursor: pointer; color: var(--danger); font-size: 1rem; line-height: 1; padding: 0; margin-left: 2px; }
    .add-row { display: flex; gap: 8px; }
    .add-row input { flex: 1; padding: 9px 12px; border: 1.5px solid var(--border); border-radius: 8px; font-size: .9rem; }
    .add-row input:focus { outline: none; border-color: var(--primary); }
    .empty { text-align: center; color: var(--text-muted); padding: 32px; font-size: .95rem; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #toast {
      position: fixed; top: 20px; right: 20px; z-index: 9999;
      background: var(--primary); color: #fff; padding: 12px 18px;
      border-radius: 10px; font-size: .9rem; box-shadow: 0 4px 20px rgba(0,0,0,.2);
      transform: translateX(120%); transition: transform .3s; max-width: 300px;
    }
    #toast.show { transform: translateX(0); }
    .divider { height: 1px; background: var(--border); margin: 16px 0; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .stat-card { background: #f8f9fa; border-radius: 10px; padding: 14px; text-align: center; border: 1.5px solid var(--border); }
    .stat-value { font-size: 1.6rem; font-weight: 700; color: var(--primary); }
    .stat-label { font-size: .75rem; color: var(--text-muted); margin-top: 3px; text-transform: uppercase; letter-spacing: .05em; }
    .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 12px; }
    .filter-row .form-group { flex: 1; min-width: 120px; }
    #notifBar {
      background: var(--info); color: #fff; text-align: center; padding: 8px 16px;
      font-size: .82rem; display: none; align-items: center; justify-content: center; gap: 10px;
    }
    #notifBar button { background: #fff; color: var(--info); border: none; border-radius: 6px; padding: 4px 12px; font-weight: 700; cursor: pointer; font-size: .82rem; }
    .running-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #4ade80; animation: pulse 1.2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.8)} }
    /* Toggle switch */
    .toggle-wrap { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; }
    .toggle-wrap + .toggle-wrap { border-top: 1px solid var(--border); }
    .toggle-info .toggle-title { font-weight: 600; font-size: .95rem; }
    .toggle-info .toggle-sub   { font-size: .8rem; color: var(--text-muted); margin-top: 2px; }
    .toggle-switch { position: relative; display: inline-block; width: 46px; height: 26px; flex-shrink: 0; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background: #ccc; border-radius: 26px; transition: .3s;
    }
    .toggle-slider::before {
      content: ''; position: absolute; height: 20px; width: 20px;
      left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: .3s;
    }
    .toggle-switch input:checked + .toggle-slider { background: var(--success); }
    .toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }
    /* Sync status badge */
    .sync-badge { display: inline-flex; align-items: center; gap: 5px; font-size: .82rem; padding: 4px 10px; border-radius: 99px; font-weight: 600; }
    .sync-ok  { background: #dcfce7; color: #16a34a; }
    .sync-err { background: #fee2e2; color: #dc2626; }
    .sync-pending { background: #fef3c7; color: #d97706; }
    @media (max-width: 600px) {
      header h1 { font-size: 1rem; }
      .timer-display { font-size: 2.2rem; }
      .form-row { flex-direction: column; }
      .btn-lg { font-size: .95rem; }
      .tab-btn { font-size: .78rem; padding: 8px 4px; }
    }

    /* â”€â”€ PWA / iOS Safe Area â”€â”€ */
    body {
      padding-bottom: max(40px, env(safe-area-inset-bottom));
    }
    header {
      padding-top: max(18px, calc(env(safe-area-inset-top) + 8px));
      padding-left:  max(24px, env(safe-area-inset-left));
      padding-right: max(24px, env(safe-area-inset-right));
    }
    .tabs {
      position: sticky;
      top: 0;
      z-index: 90;
    }

    /* å¢å¤§æ‰‹æ©Ÿè§¸æ§ç›®æ¨™ */
    @media (hover: none) and (pointer: coarse) {
      .btn   { min-height: 44px; }
      .tab-btn { min-height: 40px; }
      select, input[type="text"], input[type="date"] { min-height: 44px; }
      .del-btn { padding: 6px; }
    }

    /* PWA å®‰è£æ©«å¹… */
    #installBanner {
      display: none;
      background: linear-gradient(135deg, var(--accent), #b8972e);
      color: #fff;
      padding: 10px 16px;
      align-items: center;
      gap: 10px;
      font-size: .88rem;
    }
    #installBanner button {
      background: rgba(255,255,255,.25);
      color: #fff;
      border: 1.5px solid rgba(255,255,255,.6);
      border-radius: 7px;
      padding: 5px 14px;
      font-weight: 700;
      cursor: pointer;
      font-size: .85rem;
      white-space: nowrap;
    }
    #installBanner .install-dismiss {
      background: none;
      border: none;
      font-size: 1.2rem;
      opacity: .7;
      cursor: pointer;
      margin-left: auto;
      padding: 0 4px;
    }

    /* é›¢ç·šæç¤º */
    #offlineBanner {
      display: none;
      background: #374151;
      color: #fff;
      text-align: center;
      padding: 8px;
      font-size: .82rem;
    }
  </style>
</head>
<body>

<!-- PWA å®‰è£æ©«å¹… (Android/Chrome) -->
<div id="installBanner">
  <span>ğŸ“² å®‰è£åˆ°æ‰‹æ©Ÿä¸»ç•«é¢ï¼Œéš¨æ™‚å¿«é€Ÿé–‹å•Ÿ</span>
  <button id="installBtn">å®‰è£ App</button>
  <button class="install-dismiss" onclick="dismissInstall()">âœ•</button>
</div>

<!-- é›¢ç·šæç¤º -->
<div id="offlineBanner">âš¡ ç›®å‰ç‚ºé›¢ç·šæ¨¡å¼ï¼Œè³‡æ–™ä»å¯æ­£å¸¸ä½¿ç”¨</div>

<!-- iOS å®‰è£æç¤º (Safari) -->
<div id="iosBanner" style="display:none;background:#1a3557;color:#fff;padding:12px 16px;font-size:.85rem;text-align:center;line-height:1.6;">
  ğŸ“± åœ¨ Safari ä¸­ï¼šé»é¸ä¸‹æ–¹ <strong>åˆ†äº«</strong> æŒ‰éˆ• â†’ã€Œ<strong>åŠ å…¥ä¸»ç•«é¢</strong>ã€å³å¯å®‰è£
  <button onclick="document.getElementById('iosBanner').style.display='none'"
    style="display:block;margin:8px auto 0;background:rgba(255,255,255,.2);border:none;color:#fff;padding:4px 16px;border-radius:6px;cursor:pointer;">çŸ¥é“äº†</button>
</div>

<div id="notifBar">
  <span>ğŸ”” å…è¨±é€šçŸ¥ä»¥æ¥æ”¶å°ˆæ¡ˆæœŸé™æé†’</span>
  <button onclick="requestNotifPermission()">å…è¨±é€šçŸ¥</button>
  <button onclick="document.getElementById('notifBar').style.display='none'" style="background:rgba(255,255,255,.3);color:#fff;">ç¨å¾Œ</button>
</div>

<header>
  <div class="logo">âš–ï¸</div>
  <div>
    <h1>å¾‹å¸«è¨ˆæ™‚ç®¡ç†ç³»çµ±</h1>
    <div class="subtitle">Attorney Time Tracking &amp; Deadline Manager</div>
  </div>
  <div class="header-right">
    <div id="currentTime"></div>
    <div id="currentDate" style="font-size:.68rem;opacity:.6;"></div>
  </div>
</header>

<div id="alertBanner">
  <div class="alert-title">âš ï¸ å°ˆæ¡ˆæœŸé™æé†’</div>
  <ul id="alertList"></ul>
</div>

<div id="toast"></div>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('timer',this)">â± è¨ˆæ™‚</button>
    <button class="tab-btn" onclick="switchTab('records',this)">ğŸ“‹ ç´€éŒ„</button>
    <button class="tab-btn" onclick="switchTab('projects',this)">ğŸ“ å°ˆæ¡ˆ</button>
    <button class="tab-btn" onclick="switchTab('manage',this)">âš™ï¸ ç®¡ç†</button>
    <button class="tab-btn" onclick="switchTab('sheets',this)">â˜ï¸ é›²ç«¯</button>
  </div>

  <!-- ========== TAB: TIMER ========== -->
  <div id="tab-timer" class="tab-content active">
    <div class="timer-section">
      <div class="timer-label">æœ¬æ¬¡è¨ˆæ™‚</div>
      <div class="timer-display" id="timerDisplay">00:00:00</div>
      <div class="timer-context" id="timerContext">å°šæœªé–‹å§‹è¨ˆæ™‚</div>
      <div class="timer-cumulative">
        <div class="cum-label">å°ˆæ¡ˆç´¯è¨ˆæ™‚é–“</div>
        <div class="cum-value" id="cumulativeDisplay">â€”</div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“ å·¥ä½œè¨˜éŒ„</div>
      <div class="form-row">
        <div class="form-group">
          <label>å§”è¨—äºº</label>
          <select id="clientSelect" onchange="onClientChange()">
            <option value="">â€” è«‹é¸æ“‡å§”è¨—äºº â€”</option>
          </select>
        </div>
        <div class="form-group">
          <label>å°ˆæ¡ˆ</label>
          <select id="projectSelect" onchange="onProjectChange()">
            <option value="">â€” è«‹é¸æ“‡å°ˆæ¡ˆ â€”</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group" style="flex:2;">
          <label>æœ¬æ¬¡å·¥ä½œå…§å®¹</label>
          <textarea id="workNote" placeholder="è«‹è¼¸å…¥æœ¬æ¬¡å°ˆæ¡ˆå·¥ä½œæˆ–å‚™æ³¨å…§å®¹â€¦"></textarea>
        </div>
      </div>
      <button id="timerBtn" class="btn btn-start btn-lg" onclick="toggleTimer()">
        <span id="timerBtnIcon">â–¶</span>
        <span id="timerBtnText">é–‹å§‹è¨ˆæ™‚</span>
      </button>
    </div>
  </div><!-- END tab-timer -->

  <!-- ========== TAB: RECORDS ========== -->
  <div id="tab-records" class="tab-content">
    <div class="card">
      <div class="card-title">ğŸ“‹ å·¥ä½œè¨˜éŒ„æŸ¥è©¢</div>
      <div class="filter-row">
        <div class="form-group">
          <label>ç¯©é¸å§”è¨—äºº</label>
          <select id="filterClient" onchange="renderRecords()">
            <option value="">å…¨éƒ¨</option>
          </select>
        </div>
        <div class="form-group">
          <label>ç¯©é¸å°ˆæ¡ˆ</label>
          <select id="filterProject" onchange="renderRecords()">
            <option value="">å…¨éƒ¨</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button class="btn btn-outline btn-sm" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡º CSV</button>
        </div>
      </div>
      <div class="stats-grid" id="recordStats"></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>æ—¥æœŸ</th><th>å§”è¨—äºº</th><th>å°ˆæ¡ˆ</th>
              <th>å·¥ä½œå…§å®¹</th><th>æœ¬æ¬¡æ™‚é–“</th><th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="recordsBody">
            <tr><td colspan="6" class="empty">å°šç„¡ç´€éŒ„</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div><!-- END tab-records -->

  <!-- ========== TAB: PROJECTS ========== -->
  <div id="tab-projects" class="tab-content">
    <div class="card">
      <div class="card-title">ğŸ“ å°ˆæ¡ˆç¸½è¦½</div>
      <div id="projectsOverview"><div class="empty">å°šç„¡å°ˆæ¡ˆè³‡æ–™</div></div>
    </div>
  </div><!-- END tab-projects -->

  <!-- ========== TAB: MANAGE ========== -->
  <div id="tab-manage" class="tab-content">
    <div class="card">
      <div class="card-title">ğŸ‘¤ å§”è¨—äººç®¡ç†</div>
      <div class="add-row">
        <input type="text" id="newClientInput" placeholder="æ–°å¢å§”è¨—äººå§“åâ€¦" onkeydown="if(event.key==='Enter')addClient()" />
        <button class="btn btn-primary" onclick="addClient()">ï¼‹ æ–°å¢</button>
      </div>
      <div class="list-items" id="clientList"></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“ å°ˆæ¡ˆç®¡ç†</div>
      <div class="form-row">
        <div class="form-group">
          <label>å§”è¨—äºº</label>
          <select id="newProjClient">
            <option value="">â€” è«‹é¸æ“‡ â€”</option>
          </select>
        </div>
        <div class="form-group" style="flex:2;">
          <label>å°ˆæ¡ˆåç¨±</label>
          <input type="text" id="newProjName" placeholder="å°ˆæ¡ˆåç¨±â€¦" />
        </div>
        <div class="form-group">
          <label>å°ˆæ¡ˆæœŸé™</label>
          <input type="date" id="newProjDeadline" />
        </div>
      </div>
      <button class="btn btn-accent" onclick="addProject()">ï¼‹ æ–°å¢å°ˆæ¡ˆ</button>
      <div class="divider"></div>
      <div id="manageProjectList"><div class="empty">å°šç„¡å°ˆæ¡ˆ</div></div>
    </div>
    <div class="card" style="border:1.5px solid #fee2e2;">
      <div class="card-title" style="color:var(--danger);">ğŸ—‘ è³‡æ–™ç®¡ç†</div>
      <button class="btn btn-outline btn-sm" onclick="clearAllData()" style="color:var(--danger);border-color:var(--danger);">æ¸…é™¤å…¨éƒ¨è³‡æ–™</button>
    </div>
  </div><!-- END tab-manage -->

  <!-- ========== TAB: SHEETS ========== -->
  <div id="tab-sheets" class="tab-content">

    <div class="card">
      <div class="card-title">â˜ï¸ Google Sheets é›²ç«¯åŒæ­¥è¨­å®š</div>
      <div style="background:#f0f7ff;border-radius:9px;padding:14px;margin-bottom:16px;font-size:.88rem;line-height:1.8;border-left:4px solid var(--info);">
        <strong>è¨­å®šæ­¥é©Ÿï¼ˆåªéœ€åšä¸€æ¬¡ï¼‰ï¼š</strong><br>
        1. é–‹å•Ÿ Google Sheetsï¼Œå»ºç«‹æ–°è©¦ç®—è¡¨<br>
        2. ä¸Šæ–¹é¸å–®ã€Œæ“´å……åŠŸèƒ½ã€â†’ã€ŒApps Scriptã€ï¼Œè²¼ä¸Š <code>Code.gs</code> å…§å®¹ä¸¦å„²å­˜<br>
        3. ã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ã€â†’ é¡å‹é¸ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€<br>
        &nbsp;&nbsp;&nbsp;â€¢ ä»¥å“ªå€‹èº«åˆ†åŸ·è¡Œï¼š<strong>æˆ‘</strong>ã€€&nbsp;èª°å¯ä»¥å­˜å–ï¼š<strong>æ‰€æœ‰äºº</strong><br>
        4. è¤‡è£½éƒ¨ç½² URLï¼ˆä»¥ /exec çµå°¾ï¼‰ï¼Œè²¼åˆ°ä¸‹æ–¹
      </div>
      <div class="form-group" style="margin-bottom:14px;">
        <label>Apps Script éƒ¨ç½² URL</label>
        <input type="text" id="appsScriptUrl"
          placeholder="https://script.google.com/macros/s/xxxxxx/exec"
          style="font-size:.85rem;"
          oninput="saveScriptUrl()" />
      </div>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="testConnection()">ğŸ”Œ æ¸¬è©¦é€£ç·š</button>
        <div id="connStatus" style="font-size:.88rem;color:var(--text-muted);">å°šæœªæ¸¬è©¦</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">ğŸ”„ è³‡æ–™åŒæ­¥</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="syncPendingCount">â€”</div>
          <div class="stat-label">å¾…åŒæ­¥ç­†æ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="syncedCount">â€”</div>
          <div class="stat-label">å·²åŒæ­¥ç­†æ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="lastSyncTime" style="font-size:.95rem;">â€”</div>
          <div class="stat-label">æœ€å¾ŒåŒæ­¥æ™‚é–“</div>
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;">
        <button class="btn btn-primary" onclick="syncAllToSheets()">â˜ï¸ ä¸Šå‚³ï¼ˆæœ¬æ©Ÿâ†’Sheetsï¼‰</button>
        <button class="btn btn-secondary" onclick="pullFromSheets()">ğŸ“¥ åŒ¯å…¥ï¼ˆSheetsâ†’æœ¬æ©Ÿï¼‰</button>
        <button class="btn btn-outline" onclick="refreshSyncStats()">ğŸ”ƒ é‡æ–°æ•´ç†</button>
      </div>
      <div style="font-size:.82rem;color:var(--text-muted);">
        ğŸ’¡ <b>ä¸Šå‚³</b>ï¼šå°‡æœ¬æ©Ÿè³‡æ–™æ¨é€åˆ° Sheetsã€‚<b>åŒ¯å…¥</b>ï¼šå¾ Sheets è®€å–è³‡æ–™åˆ°æœ¬æ©Ÿï¼ˆé©åˆå¤šè£ç½®åŒæ­¥ï¼‰ã€‚
      </div>
    </div>

    <div class="card">
      <div class="card-title">âš™ï¸ è‡ªå‹•åŒæ­¥è¨­å®š</div>
      <div class="toggle-wrap">
        <div class="toggle-info">
          <div class="toggle-title">åœæ­¢è¨ˆæ™‚å¾Œè‡ªå‹•åŒæ­¥</div>
          <div class="toggle-sub">æ¯æ¬¡è¨ˆæ™‚çµæŸè‡ªå‹•ä¸Šå‚³åˆ° Google Sheets</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="autoSyncToggle" onchange="saveSettings()">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="toggle-wrap">
        <div class="toggle-info">
          <div class="toggle-title">é¡¯ç¤ºåŒæ­¥ç‹€æ…‹é€šçŸ¥</div>
          <div class="toggle-sub">æ¯æ¬¡åŒæ­¥å¾Œé¡¯ç¤ºæˆåŠŸæˆ–å¤±æ•—æç¤º</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="showSyncNotif" checked onchange="saveSettings()">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <div class="card">
      <div class="card-title">ğŸ“œ åŒæ­¥ç´€éŒ„</div>
      <div id="syncLog" style="font-size:.82rem;max-height:220px;overflow-y:auto;">
        <div class="empty">å°šç„¡åŒæ­¥è¨˜éŒ„</div>
      </div>
    </div>

  </div><!-- END tab-sheets -->

</div><!-- END .container -->

<script>
/* ============================================================
   è³‡æ–™å±¤
   ============================================================ */
let data = {
  clients:  [],   // [{id, name}]
  projects: [],   // [{id, clientId, name, deadline, archived}]
  records:  []    // [{id, clientId, projectId, date, dateISO, start, end, duration, note}]
};

function loadData() {
  try {
    const saved = localStorage.getItem('lawyerTimerData');
    if (saved) data = JSON.parse(saved);
  } catch(e) {}
}

function saveData() {
  localStorage.setItem('lawyerTimerData', JSON.stringify(data));
}

function uid() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2,7);
}

/* ============================================================
   åˆå§‹åŒ–
   ============================================================ */
loadData();

function init() {
  updateClock();
  setInterval(updateClock, 1000);
  populateAllDropdowns();
  checkDeadlines();
  setInterval(checkDeadlines, 60 * 60 * 1000);
  checkNotifPermission();
}

function updateClock() {
  const now = new Date();
  document.getElementById('currentTime').textContent = now.toLocaleTimeString('zh-TW');
  document.getElementById('currentDate').textContent =
    now.toLocaleDateString('zh-TW', {year:'numeric',month:'long',day:'numeric',weekday:'short'});
}

/* ============================================================
   åˆ†é åˆ‡æ›
   ============================================================ */
function switchTab(tab, btn) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  if (btn) btn.classList.add('active');
  if (tab === 'records')  renderRecords();
  if (tab === 'projects') renderProjectsOverview();
  if (tab === 'manage')   renderManageProjects();
  if (tab === 'sheets')   loadSheetsTab();
}

/* ============================================================
   å§”è¨—äºº
   ============================================================ */
function addClient() {
  const input = document.getElementById('newClientInput');
  const name  = input.value.trim();
  if (!name) { showToast('è«‹è¼¸å…¥å§”è¨—äººå§“å'); return; }
  if (data.clients.find(c => c.name === name)) { showToast('å§”è¨—äººå·²å­˜åœ¨'); return; }
  data.clients.push({ id: uid(), name });
  input.value = '';
  saveData();
  populateAllDropdowns();
  renderClientList();
  showToast('å·²æ–°å¢ï¼š' + name);
}

function deleteClient(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å§”è¨—äººï¼Ÿ')) return;
  data.clients = data.clients.filter(c => c.id !== id);
  saveData();
  populateAllDropdowns();
  renderClientList();
}

function renderClientList() {
  const container = document.getElementById('clientList');
  if (!data.clients.length) {
    container.innerHTML = '<span style="color:var(--text-muted);font-size:.85rem;">å°šç„¡å§”è¨—äºº</span>';
    return;
  }
  container.innerHTML = data.clients.map(c =>
    `<div class="list-item">
      <span>ğŸ‘¤ ${escHtml(c.name)}</span>
      <button class="del-btn" onclick="deleteClient('${c.id}')">âœ•</button>
    </div>`
  ).join('');
}

/* ============================================================
   å°ˆæ¡ˆ
   ============================================================ */
function addProject() {
  const clientId = document.getElementById('newProjClient').value;
  const name     = document.getElementById('newProjName').value.trim();
  const deadline = document.getElementById('newProjDeadline').value;
  if (!clientId) { showToast('è«‹é¸æ“‡å§”è¨—äºº'); return; }
  if (!name)     { showToast('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±'); return; }
  if (data.projects.find(p => p.clientId === clientId && p.name === name && !p.archived)) {
    showToast('æ­¤å§”è¨—äººå·²æœ‰åŒåå°ˆæ¡ˆ'); return;
  }
  data.projects.push({ id: uid(), clientId, name, deadline: deadline || '', archived: false });
  document.getElementById('newProjName').value    = '';
  document.getElementById('newProjDeadline').value = '';
  saveData();
  populateAllDropdowns();
  renderManageProjects();
  checkDeadlines();
  showToast('å·²æ–°å¢å°ˆæ¡ˆï¼š' + name);
}

function deleteProject(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å°ˆæ¡ˆï¼Ÿï¼ˆè¨ˆæ™‚ç´€éŒ„ä»ä¿ç•™ï¼‰')) return;
  data.projects = data.projects.filter(p => p.id !== id);
  saveData();
  populateAllDropdowns();
  renderManageProjects();
}

function updateDeadline(id, val) {
  const proj = data.projects.find(p => p.id === id);
  if (proj) { proj.deadline = val; saveData(); checkDeadlines(); }
}

function renderManageProjects() {
  const container = document.getElementById('manageProjectList');
  if (!data.projects.length) { container.innerHTML = '<div class="empty">å°šç„¡å°ˆæ¡ˆ</div>'; return; }
  const sorted = [...data.projects].sort((a,b) => (a.deadline||'9999') > (b.deadline||'9999') ? 1 : -1);
  container.innerHTML = sorted.map(p => {
    const client    = data.clients.find(c => c.id === p.clientId);
    const clientName = client ? client.name : '(å·²åˆªé™¤)';
    const cum       = getProjectCumulative(p.id);
    return `
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:10px 0;border-bottom:1px solid var(--border);">
        <div style="flex:1;min-width:180px;">
          <div style="font-weight:700;">${escHtml(p.name)}</div>
          <div style="font-size:.8rem;color:var(--text-muted);">ğŸ‘¤ ${escHtml(clientName)} ï½œ â± ç´¯è¨ˆ ${formatDuration(cum)}</div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
          ${deadlineStatus(p.deadline)}
          <input type="date" value="${p.deadline||''}" onchange="updateDeadline('${p.id}',this.value)"
            style="padding:5px 8px;border:1.5px solid var(--border);border-radius:6px;font-size:.8rem;" />
          <button class="btn btn-sm" style="background:#fee2e2;color:var(--danger);border:none;" onclick="deleteProject('${p.id}')">åˆªé™¤</button>
        </div>
      </div>`;
  }).join('');
}

/* ============================================================
   ä¸‹æ‹‰é¸å–®
   ============================================================ */
function populateAllDropdowns() {
  ['clientSelect','newProjClient','filterClient'].forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    const cur = sel.value;
    const isFilter = (id === 'filterClient');
    sel.innerHTML = (isFilter ? '<option value="">å…¨éƒ¨å§”è¨—äºº</option>' : '<option value="">â€” è«‹é¸æ“‡å§”è¨—äºº â€”</option>') +
      data.clients.map(c => `<option value="${c.id}">${escHtml(c.name)}</option>`).join('');
    if (cur) sel.value = cur;
  });
  renderClientList();
  updateProjectDropdowns();
}

function updateProjectDropdowns() {
  const clientId = document.getElementById('clientSelect')?.value || '';
  const ps  = document.getElementById('projectSelect');
  const fps = document.getElementById('filterProject');
  if (ps) {
    const cur   = ps.value;
    const projs = clientId ? data.projects.filter(p => p.clientId === clientId && !p.archived) : [];
    ps.innerHTML = '<option value="">â€” è«‹é¸æ“‡å°ˆæ¡ˆ â€”</option>' +
      projs.map(p => `<option value="${p.id}">${escHtml(p.name)}</option>`).join('');
    if (cur) ps.value = cur;
  }
  if (fps) {
    const filterCid = document.getElementById('filterClient')?.value || '';
    const projs = filterCid ? data.projects.filter(p => p.clientId === filterCid) : data.projects;
    fps.innerHTML = '<option value="">å…¨éƒ¨å°ˆæ¡ˆ</option>' +
      projs.map(p => `<option value="${p.id}">${escHtml(p.name)}</option>`).join('');
  }
  onProjectChange();
}

function onClientChange() { updateProjectDropdowns(); }
function onProjectChange() {
  const projId = document.getElementById('projectSelect')?.value;
  const cum    = projId ? getProjectCumulative(projId) : 0;
  document.getElementById('cumulativeDisplay').textContent = projId ? formatDuration(cum) : 'â€”';
}

/* ============================================================
   è¨ˆæ™‚å™¨
   ============================================================ */
let timerRunning = false;
let timerStart   = null;
let timerInterval = null;
let currentRecord = null;

function toggleTimer() {
  timerRunning ? stopTimer() : startTimer();
}

function startTimer() {
  const clientId  = document.getElementById('clientSelect').value;
  const projectId = document.getElementById('projectSelect').value;
  if (!clientId)  { showToast('è«‹å…ˆé¸æ“‡å§”è¨—äºº'); return; }
  if (!projectId) { showToast('è«‹å…ˆé¸æ“‡å°ˆæ¡ˆ');   return; }

  timerRunning  = true;
  timerStart    = Date.now();
  currentRecord = { clientId, projectId };

  const btn = document.getElementById('timerBtn');
  btn.className = 'btn btn-stop btn-lg';
  document.getElementById('timerBtnIcon').textContent = 'â¹';
  document.getElementById('timerBtnText').textContent = 'åœæ­¢è¨ˆæ™‚';

  const client  = data.clients.find(c => c.id === clientId);
  const project = data.projects.find(p => p.id === projectId);
  document.getElementById('timerContext').innerHTML =
    `<span class="running-dot"></span> ${escHtml(client?.name||'')} â€” ${escHtml(project?.name||'')}`;

  timerInterval = setInterval(updateTimerDisplay, 1000);
  updateTimerDisplay();
  showToast('è¨ˆæ™‚é–‹å§‹');
}

function stopTimer() {
  if (!timerRunning || !currentRecord) return;
  clearInterval(timerInterval);
  timerRunning = false;

  const endTime  = Date.now();
  const duration = Math.floor((endTime - timerStart) / 1000);

  const record = {
    id:        uid(),
    clientId:  currentRecord.clientId,
    projectId: currentRecord.projectId,
    date:      new Date().toLocaleDateString('zh-TW'),
    dateISO:   new Date().toISOString().slice(0,10),
    start:     new Date(timerStart).toLocaleTimeString('zh-TW'),
    end:       new Date(endTime).toLocaleTimeString('zh-TW'),
    duration,
    note:      document.getElementById('workNote').value.trim()
  };
  data.records.push(record);
  saveData();

  const btn = document.getElementById('timerBtn');
  btn.className = 'btn btn-start btn-lg';
  document.getElementById('timerBtnIcon').textContent = 'â–¶';
  document.getElementById('timerBtnText').textContent = 'é–‹å§‹è¨ˆæ™‚';
  document.getElementById('timerContext').textContent = 'è¨ˆæ™‚çµæŸ';
  document.getElementById('cumulativeDisplay').textContent = formatDuration(getProjectCumulative(record.projectId));
  document.getElementById('timerDisplay').textContent = '00:00:00';

  currentRecord = null;
  document.getElementById('workNote').value = '';
  showToast(`è¨ˆæ™‚çµæŸï¼Œæœ¬æ¬¡ ${formatDuration(duration)}`);

  // è‡ªå‹•åŒæ­¥åˆ° Google Sheets
  const s = getSyncSettings();
  if (s.autoSync && getScriptUrl()) {
    setTimeout(async () => {
      const ok = await syncRecord(record);
      if (s.showSyncNotif) {
        showToast(ok ? 'â˜ï¸ å·²åŒæ­¥åˆ° Google Sheets' : 'âš ï¸ åŒæ­¥å¤±æ•—ï¼Œå¯è‡³é›²ç«¯é é¢æ‰‹å‹•åŒæ­¥');
      }
    }, 900);
  }
}

function updateTimerDisplay() {
  if (!timerRunning) return;
  const elapsed = Math.floor((Date.now() - timerStart) / 1000);
  document.getElementById('timerDisplay').textContent = formatDuration(elapsed);
}

/* ============================================================
   è¨ˆæ™‚ç´€éŒ„é 
   ============================================================ */
function renderRecords() {
  const filterCid = document.getElementById('filterClient')?.value || '';
  const filterPid = document.getElementById('filterProject')?.value || '';

  const fps = document.getElementById('filterProject');
  if (fps) {
    const cur   = fps.value;
    const projs = filterCid ? data.projects.filter(p => p.clientId === filterCid) : data.projects;
    fps.innerHTML = '<option value="">å…¨éƒ¨å°ˆæ¡ˆ</option>' +
      projs.map(p => `<option value="${p.id}">${escHtml(p.name)}</option>`).join('');
    if (cur) fps.value = cur;
  }

  let records = [...data.records];
  if (filterCid) records = records.filter(r => r.clientId  === filterCid);
  if (filterPid) records = records.filter(r => r.projectId === filterPid);
  records.sort((a,b) => b.dateISO > a.dateISO ? 1 : -1);

  const totalSec      = records.reduce((s,r) => s + (r.duration||0), 0);
  const uniqueClients = new Set(records.map(r => r.clientId)).size;
  const uniqueProjs   = new Set(records.map(r => r.projectId)).size;
  document.getElementById('recordStats').innerHTML = `
    <div class="stat-card"><div class="stat-value">${records.length}</div><div class="stat-label">ç´€éŒ„ç­†æ•¸</div></div>
    <div class="stat-card"><div class="stat-value">${formatDuration(totalSec)}</div><div class="stat-label">ç¸½è¨ˆæ™‚é–“</div></div>
    <div class="stat-card"><div class="stat-value">${uniqueClients}</div><div class="stat-label">å§”è¨—äººæ•¸</div></div>
    <div class="stat-card"><div class="stat-value">${uniqueProjs}</div><div class="stat-label">å°ˆæ¡ˆæ•¸</div></div>`;

  const tbody = document.getElementById('recordsBody');
  if (!records.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="empty">ç„¡ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</td></tr>';
    return;
  }
  tbody.innerHTML = records.map(r => {
    const client  = data.clients.find(c => c.id === r.clientId);
    const project = data.projects.find(p => p.id === r.projectId);
    return `<tr>
      <td>${r.date}<div style="font-size:.75rem;color:var(--text-muted);">${r.start}â€“${r.end}</div></td>
      <td>${escHtml(client?.name||'(å·²åˆªé™¤)')}</td>
      <td>${escHtml(project?.name||'(å·²åˆªé™¤)')}</td>
      <td style="max-width:200px;font-size:.85rem;">${escHtml(r.note||'â€”')}</td>
      <td><strong>${formatDuration(r.duration||0)}</strong></td>
      <td><button class="btn btn-sm" style="background:#fee2e2;color:var(--danger);border:none;" onclick="deleteRecord('${r.id}')">åˆªé™¤</button></td>
    </tr>`;
  }).join('');
}

function deleteRecord(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) return;
  data.records = data.records.filter(r => r.id !== id);
  saveData();
  renderRecords();
}

/* ============================================================
   å°ˆæ¡ˆç¸½è¦½é 
   ============================================================ */
function renderProjectsOverview() {
  const container = document.getElementById('projectsOverview');
  if (!data.projects.length) { container.innerHTML = '<div class="empty">å°šç„¡å°ˆæ¡ˆè³‡æ–™</div>'; return; }
  const groups = {};
  data.clients.forEach(c => { groups[c.id] = { name: c.name, projects: [] }; });
  data.projects.forEach(p => {
    if (!groups[p.clientId]) groups[p.clientId] = { name:'(å·²åˆªé™¤)', projects:[] };
    groups[p.clientId].projects.push(p);
  });
  let html = '';
  Object.entries(groups).forEach(([cid, g]) => {
    if (!g.projects.length) return;
    html += `<div style="margin-bottom:20px;">
      <div style="font-weight:700;color:var(--primary);margin-bottom:10px;">ğŸ‘¤ ${escHtml(g.name)}</div>
      <div class="table-wrap"><table>
        <thead><tr><th>å°ˆæ¡ˆåç¨±</th><th>æˆªæ­¢æ—¥æœŸ</th><th>è·æˆªæ­¢</th><th>ç´¯è¨ˆæ™‚é–“</th><th>ç´€éŒ„æ•¸</th></tr></thead>
        <tbody>`;
    g.projects.forEach(p => {
      const cum      = getProjectCumulative(p.id);
      const recCount = data.records.filter(r => r.projectId === p.id).length;
      const dLeft    = deadlineDaysLeft(p.deadline);
      let daysCell   = 'â€”';
      if (dLeft !== null) {
        if      (dLeft < 0)  daysCell = `<span class="deadline-danger">å·²é€¾æœŸ ${Math.abs(dLeft)} å¤©</span>`;
        else if (dLeft === 0) daysCell = `<span class="deadline-danger">ä»Šæ—¥åˆ°æœŸï¼</span>`;
        else if (dLeft <= 3) daysCell = `<span class="deadline-danger">âš  å‰© ${dLeft} å¤©</span>`;
        else if (dLeft <= 7) daysCell = `<span class="deadline-warn">å‰© ${dLeft} å¤©</span>`;
        else                 daysCell = `<span class="deadline-ok">å‰© ${dLeft} å¤©</span>`;
      }
      html += `<tr>
        <td><strong>${escHtml(p.name)}</strong></td>
        <td>${p.deadline||'ç„¡æœŸé™'}</td>
        <td>${daysCell}</td>
        <td><strong>${formatDuration(cum)}</strong></td>
        <td>${recCount}</td>
      </tr>`;
    });
    html += '</tbody></table></div></div>';
  });
  container.innerHTML = html || '<div class="empty">å°šç„¡è³‡æ–™</div>';
}

/* ============================================================
   ç´¯è¨ˆæ™‚é–“
   ============================================================ */
function getProjectCumulative(projectId) {
  return data.records.filter(r => r.projectId === projectId).reduce((s,r) => s + (r.duration||0), 0);
}

/* ============================================================
   æˆªæ­¢æ—¥æœŸæé†’
   ============================================================ */
function checkDeadlines() {
  const banner  = document.getElementById('alertBanner');
  const list    = document.getElementById('alertList');
  const warnings = [];

  data.projects.forEach(p => {
    if (!p.deadline || p.archived) return;
    const d      = deadlineDaysLeft(p.deadline);
    if (d === null) return;
    const client = data.clients.find(c => c.id === p.clientId);
    const cn     = client ? client.name : '(æœªçŸ¥)';
    if (d < 0) {
      warnings.push(`ã€${cn}ã€‘${p.name} â€” <strong style="color:var(--danger);">å·²é€¾æœŸ ${Math.abs(d)} å¤©</strong>ï¼ˆ${p.deadline}ï¼‰`);
      scheduleNotification('å°ˆæ¡ˆé€¾æœŸ', `ã€${cn}ã€‘${p.name} å·²é€¾æœŸ ${Math.abs(d)} å¤©ï¼`);
    } else if (d === 0) {
      warnings.push(`ã€${cn}ã€‘${p.name} â€” <strong style="color:var(--danger);">ä»Šæ—¥åˆ°æœŸï¼</strong>`);
      scheduleNotification('ä»Šæ—¥åˆ°æœŸ', `ã€${cn}ã€‘${p.name} ä»Šå¤©åˆ°æœŸï¼Œè«‹ç«‹å³è™•ç†ï¼`);
    } else if (d <= 3) {
      warnings.push(`ã€${cn}ã€‘${p.name} â€” <strong style="color:var(--danger);">é‚„æœ‰ ${d} å¤©åˆ°æœŸ</strong>ï¼ˆ${p.deadline}ï¼‰`);
      scheduleNotification('æœŸé™å°‡è‡³', `ã€${cn}ã€‘${p.name} å‰© ${d} å¤©ï¼`);
    } else if (d <= 7) {
      warnings.push(`ã€${cn}ã€‘${p.name} â€” é‚„æœ‰ ${d} å¤©åˆ°æœŸï¼ˆ${p.deadline}ï¼‰`);
    }
  });

  if (warnings.length) {
    list.innerHTML = warnings.map(w => `<li>${w}</li>`).join('');
    banner.style.display = 'block';
  } else {
    banner.style.display = 'none';
  }
}

function deadlineDaysLeft(deadline) {
  if (!deadline) return null;
  const d     = new Date(deadline); d.setHours(0,0,0,0);
  const today = new Date();         today.setHours(0,0,0,0);
  return Math.round((d - today) / 86400000);
}

function deadlineStatus(deadline) {
  const d = deadlineDaysLeft(deadline);
  if (d === null)  return '<span style="color:var(--text-muted);font-size:.8rem;">ç„¡æœŸé™</span>';
  if (d < 0)       return `<span class="badge badge-danger">é€¾æœŸ ${Math.abs(d)} å¤©</span>`;
  if (d === 0)     return `<span class="badge badge-danger">ä»Šæ—¥åˆ°æœŸ</span>`;
  if (d <= 3)      return `<span class="badge badge-danger">å‰© ${d} å¤©</span>`;
  if (d <= 7)      return `<span class="badge badge-warning">å‰© ${d} å¤©</span>`;
  return           `<span class="badge badge-success">å‰© ${d} å¤©</span>`;
}

/* ============================================================
   ç€è¦½å™¨é€šçŸ¥
   ============================================================ */
function checkNotifPermission() {
  if (!('Notification' in window)) return;
  if (Notification.permission === 'default') document.getElementById('notifBar').style.display = 'flex';
}
function requestNotifPermission() {
  Notification.requestPermission().then(p => {
    document.getElementById('notifBar').style.display = 'none';
    showToast(p === 'granted' ? 'é€šçŸ¥å·²å•Ÿç”¨' : 'é€šçŸ¥æœªé–‹å•Ÿ');
  });
}
let _lastNotif = {};
function scheduleNotification(title, body) {
  if (!('Notification' in window) || Notification.permission !== 'granted') return;
  const key = title + body;
  if (_lastNotif[key] && Date.now() - _lastNotif[key] < 3600000) return;
  _lastNotif[key] = Date.now();
  new Notification(title, { body });
}

/* ============================================================
   åŒ¯å‡º CSV
   ============================================================ */
function exportCSV() {
  const filterCid = document.getElementById('filterClient')?.value || '';
  const filterPid = document.getElementById('filterProject')?.value || '';
  let records = [...data.records];
  if (filterCid) records = records.filter(r => r.clientId  === filterCid);
  if (filterPid) records = records.filter(r => r.projectId === filterPid);

  const rows = [['æ—¥æœŸ','é–‹å§‹','çµæŸ','å§”è¨—äºº','å°ˆæ¡ˆ','å·¥ä½œå…§å®¹','æœ¬æ¬¡æ™‚é–“(ç§’)','æœ¬æ¬¡æ™‚é–“']];
  records.forEach(r => {
    const c = data.clients.find(x => x.id === r.clientId);
    const p = data.projects.find(x => x.id === r.projectId);
    rows.push([r.date, r.start, r.end, c?.name||'', p?.name||'', r.note||'', r.duration||0, formatDuration(r.duration||0)]);
  });
  const csv  = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob(['\ufeff'+csv], { type:'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = 'å¾‹å¸«è¨ˆæ™‚ç´€éŒ„_' + new Date().toLocaleDateString('zh-TW').replace(/\//g,'-') + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}

/* ============================================================
   æ¸…é™¤å…¨éƒ¨
   ============================================================ */
function clearAllData() {
  if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤æ“ä½œç„¡æ³•é‚„åŸï¼')) return;
  if (!confirm('å†æ¬¡ç¢ºèªï¼šæ¸…é™¤å…¨éƒ¨è³‡æ–™ï¼Ÿ')) return;
  data = { clients:[], projects:[], records:[] };
  saveData();
  populateAllDropdowns();
  renderRecords();
  renderManageProjects();
  renderProjectsOverview();
  checkDeadlines();
  showToast('å·²æ¸…é™¤å…¨éƒ¨è³‡æ–™');
}

/* ============================================================
   Google Sheets ä¸²æ¥
   ============================================================ */

// â”€â”€ è¨­å®šå­˜å– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getScriptUrl() {
  return localStorage.getItem('appsScriptUrl') || '';
}
function saveScriptUrl() {
  const url = document.getElementById('appsScriptUrl').value.trim();
  localStorage.setItem('appsScriptUrl', url);
}
function getSyncSettings() {
  return {
    autoSync:      localStorage.getItem('autoSync') === 'true',
    showSyncNotif: localStorage.getItem('showSyncNotif') !== 'false'
  };
}
function saveSettings() {
  localStorage.setItem('autoSync',      document.getElementById('autoSyncToggle').checked);
  localStorage.setItem('showSyncNotif', document.getElementById('showSyncNotif').checked);
}

// â”€â”€ å·²åŒæ­¥ ID ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSyncedIds() {
  try { return JSON.parse(localStorage.getItem('syncedIds') || '[]'); } catch(e) { return []; }
}
function markSynced(ids) {
  const merged = [...new Set([...getSyncedIds(), ...ids])];
  localStorage.setItem('syncedIds', JSON.stringify(merged));
}

// â”€â”€ è¼‰å…¥é›²ç«¯é é¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadSheetsTab() {
  const url = getScriptUrl();
  const el  = document.getElementById('appsScriptUrl');
  if (el && url) el.value = url;

  const s  = getSyncSettings();
  const at = document.getElementById('autoSyncToggle');
  const sn = document.getElementById('showSyncNotif');
  if (at) at.checked = s.autoSync;
  if (sn) sn.checked = s.showSyncNotif;

  refreshSyncStats();
}

// â”€â”€ çµ±è¨ˆæ›´æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshSyncStats() {
  const synced  = getSyncedIds();
  const total   = data.records.length;
  const pending = data.records.filter(r => !synced.includes(r.id)).length;
  const el1 = document.getElementById('syncPendingCount');
  const el2 = document.getElementById('syncedCount');
  const el3 = document.getElementById('lastSyncTime');
  if (el1) el1.textContent = pending;
  if (el2) el2.textContent = total - pending;
  if (el3) el3.textContent = localStorage.getItem('lastSyncTime') || 'å¾æœª';
}

// â”€â”€ åŒæ­¥ç´€éŒ„ Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addSyncLog(msg, type) {
  const log = document.getElementById('syncLog');
  if (!log) return;
  const color = type === 'ok' ? 'var(--success)' : type === 'err' ? 'var(--danger)' : 'var(--text-muted)';
  const time  = new Date().toLocaleTimeString('zh-TW');
  const empty = log.querySelector('.empty');
  if (empty) empty.remove();
  const entry = document.createElement('div');
  entry.style.cssText = `padding:5px 0;border-bottom:1px solid var(--border);color:${color};`;
  entry.innerHTML     = `<span style="color:var(--text-muted);">[${time}]</span> ${msg}`;
  log.insertBefore(entry, log.firstChild);
  while (log.children.length > 30) log.removeChild(log.lastChild);
}

// â”€â”€ æ¸¬è©¦é€£ç·š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function testConnection() {
  const url = getScriptUrl();
  if (!url) { showToast('è«‹å…ˆå¡«å…¥ Apps Script URL'); return; }
  const el = document.getElementById('connStatus');
  if (el) el.innerHTML = '<span style="color:var(--text-muted);">é€£ç·šä¸­â€¦</span>';
  try {
    const resp = await fetch(url + '?action=ping', { mode:'cors' });
    const json = await resp.json();
    if (json.ok) {
      if (el) el.innerHTML = '<span style="color:var(--success);">âœ… é€£ç·šæˆåŠŸ</span>';
      addSyncLog('é€£ç·šæ¸¬è©¦æˆåŠŸ', 'ok');
      showToast('âœ… Google Sheets é€£ç·šæˆåŠŸï¼');
    } else {
      throw new Error(json.error || 'API å›æ‡‰ç•°å¸¸');
    }
  } catch(e) {
    if (el) el.innerHTML = '<span style="color:var(--danger);">âŒ é€£ç·šå¤±æ•—</span>';
    addSyncLog('é€£ç·šæ¸¬è©¦å¤±æ•—ï¼š' + e.message, 'err');
    showToast('âŒ é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèª URL');
  }
}

// â”€â”€ å–®ç­†è‡ªå‹•åŒæ­¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function syncRecord(record) {
  const url = getScriptUrl();
  if (!url) return false;
  const client  = data.clients.find(c => c.id === record.clientId);
  const project = data.projects.find(p => p.id === record.projectId);
  const payload = {
    action: 'addRecord',
    data: {
      recordId:    record.id,
      clientName:  client?.name  || '(æœªçŸ¥)',
      projectName: project?.name || '(æœªçŸ¥)',
      deadline:    project?.deadline || '',
      date:        record.date,
      dateISO:     record.dateISO,
      start:       record.start,
      end:         record.end,
      duration:    record.duration,
      note:        record.note || ''
    }
  };
  try {
    const resp = await fetch(url, {
      method:  'POST',
      mode:    'cors',
      headers: { 'Content-Type': 'text/plain' },
      body:    JSON.stringify(payload)
    });
    const json = await resp.json();
    if (json.ok) {
      markSynced([record.id]);
      addSyncLog(`âœ… ${payload.data.clientName} / ${payload.data.projectName} (${formatDuration(record.duration)})`, 'ok');
      refreshSyncStats();
      return true;
    }
    throw new Error(json.error || 'æœªçŸ¥éŒ¯èª¤');
  } catch(e) {
    addSyncLog('âŒ å–®ç­†åŒæ­¥å¤±æ•—ï¼š' + e.message, 'err');
    return false;
  }
}

// â”€â”€ å…¨é‡åŒæ­¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function syncAllToSheets() {
  const url = getScriptUrl();
  if (!url) { showToast('è«‹å…ˆè¨­å®š Apps Script URL'); switchTab('sheets', document.querySelector('.tab-btn:last-child')); return; }
  showToast('â˜ï¸ åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™â€¦');
  addSyncLog('é–‹å§‹å…¨é‡åŒæ­¥â€¦', 'info');
  const payload = {
    action: 'syncAll',
    data:   { records: data.records, clients: data.clients, projects: data.projects }
  };
  try {
    const resp = await fetch(url, {
      method:  'POST',
      mode:    'cors',
      headers: { 'Content-Type': 'text/plain' },
      body:    JSON.stringify(payload)
    });
    const json = await resp.json();
    if (json.ok) {
      const r   = json.result;
      const now = new Date().toLocaleString('zh-TW');
      markSynced(data.records.map(rec => rec.id));
      localStorage.setItem('lastSyncTime', now);
      const el3 = document.getElementById('lastSyncTime');
      if (el3) el3.textContent = now;
      addSyncLog(`âœ… å…¨é‡åŒæ­¥å®Œæˆï¼šæ–°å¢ ${r.added} ç­†ï¼Œç•¥é ${r.skipped} ç­†`, 'ok');
      showToast(`âœ… åŒæ­¥å®Œæˆï¼æ–°å¢ ${r.added} ç­†`);
      refreshSyncStats();
    } else {
      throw new Error(json.error || 'æœªçŸ¥éŒ¯èª¤');
    }
  } catch(e) {
    addSyncLog('âŒ å…¨é‡åŒæ­¥å¤±æ•—ï¼š' + e.message, 'err');
    showToast('âŒ åŒæ­¥å¤±æ•—ï¼š' + e.message);
  }
}

// â”€â”€ å¾ Sheets åŒ¯å…¥åˆ°æœ¬æ©Ÿï¼ˆSheets â†’ æœ¬æ©Ÿï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pullFromSheets() {
  const url = getSheetsUrl();
  if (!url) { showToast('è«‹å…ˆå¡«å…¥ Google Apps Script URL'); return; }

  addSyncLog('ğŸ“¥ æ­£åœ¨å¾ Sheets è®€å–è³‡æ–™â€¦', 'info');
  try {
    const resp = await fetch(url + '?action=getAll', { mode: 'cors' });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const json = await resp.json();
    if (!json.ok) throw new Error(json.error || 'è®€å–å¤±æ•—');

    let newClients = 0, newProjects = 0, newRecords = 0;

    // â‘  åˆä½µå§”è¨—äººï¼ˆä»¥ id å»é‡ï¼Œæ²’æœ‰ id å‰‡ä»¥åç¨±å°æ‡‰ï¼‰
    (json.clients || []).forEach(sc => {
      const byId   = data.clients.find(c => c.id === sc.id);
      const byName = data.clients.find(c => c.name === sc.name);
      if (!byId && !byName) {
        data.clients.push({ id: sc.id, name: sc.name });
        newClients++;
      }
    });

    // â‘¡ åˆä½µè¨ˆæ™‚ç´€éŒ„ï¼ˆä¾ clientName / projectName æ‰¾åˆ°æˆ–æ–°å»ºæœ¬æ©Ÿ IDï¼‰
    (json.records || []).forEach(sr => {
      if (data.records.find(r => r.id === sr.id)) return; // å·²å­˜åœ¨ï¼Œç•¥é

      // æ‰¾å§”è¨—äººï¼ˆå…ˆç”¨ Sheets å›å‚³çš„ idï¼Œå†ç”¨åç¨±ï¼‰
      let client = data.clients.find(c => c.id === sr.id)   // (fallback)
                || data.clients.find(c => c.name === sr.clientName);
      if (!client) {
        client = { id: uid(), name: sr.clientName };
        data.clients.push(client);
        newClients++;
      }

      // æ‰¾å°ˆæ¡ˆï¼ˆåŒä¸€å§”è¨—äººä¸‹åŒåå°ˆæ¡ˆï¼‰
      let project = data.projects.find(p => p.clientId === client.id && p.name === sr.projectName);
      if (!project) {
        project = { id: uid(), clientId: client.id, name: sr.projectName, deadline: '', archived: false };
        data.projects.push(project);
        newProjects++;
      }

      // æ–°å¢ç´€éŒ„
      data.records.push({
        id:        sr.id,
        clientId:  client.id,
        projectId: project.id,
        date:      sr.date    || '',
        dateISO:   sr.date    || '',
        start:     sr.start   || '',
        end:       sr.end     || '',
        duration:  Number(sr.duration) || 0,
        note:      sr.note    || ''
      });
      newRecords++;
    });

    saveData();
    // å°‡å·²åŒ¯å…¥çš„ ID æ¨™è¨˜ç‚ºå·²åŒæ­¥ï¼ˆé¿å…ä¹‹å¾Œä¸Šå‚³æ™‚é‡è¤‡è¨ˆç®—ï¼‰
    markSynced((json.records || []).map(r => r.id));

    refreshSyncStats();
    populateAllDropdowns();
    renderRecords();

    const msg = `âœ… åŒ¯å…¥å®Œæˆï¼š${newClients} å§”è¨—äººï½œ${newProjects} å°ˆæ¡ˆï½œ${newRecords} ç­†ç´€éŒ„`;
    addSyncLog(msg, 'ok');
    showToast(msg);

  } catch(e) {
    addSyncLog('âŒ å¾ Sheets åŒ¯å…¥å¤±æ•—ï¼š' + e.message, 'err');
    showToast('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + e.message);
  }
}

/* ============================================================
   å·¥å…·å‡½æ•¸
   ============================================================ */
function formatDuration(sec) {
  if (!sec || sec < 0) return '00:00:00';
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let _toastTimeout = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  if (_toastTimeout) clearTimeout(_toastTimeout);
  _toastTimeout = setTimeout(() => t.classList.remove('show'), 2800);
}

/* ============================================================
   PWAï¼šService Worker è¨»å†Š
   ============================================================ */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => {
        console.log('[PWA] Service Worker å·²è¨»å†Šï¼Œç¯„åœï¼š', reg.scope);
        // æœ‰æ–°ç‰ˆæœ¬æ™‚æç¤º
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              showToast('ğŸ”„ æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
          });
        });
      })
      .catch(err => console.warn('[PWA] Service Worker è¨»å†Šå¤±æ•—ï¼š', err));
  });
}

/* ============================================================
   PWAï¼šå®‰è£æç¤º (Android / Chrome)
   ============================================================ */
let _deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  _deferredInstallPrompt = e;
  // è‹¥ä½¿ç”¨è€…æœªæ›¾é—œé–‰æ©«å¹…ï¼Œæ‰é¡¯ç¤º
  if (localStorage.getItem('installDismissed') !== 'true') {
    document.getElementById('installBanner').style.display = 'flex';
  }
});

document.getElementById('installBtn').addEventListener('click', async () => {
  if (!_deferredInstallPrompt) return;
  _deferredInstallPrompt.prompt();
  const { outcome } = await _deferredInstallPrompt.userChoice;
  if (outcome === 'accepted') {
    showToast('âœ… App å·²å®‰è£ï¼');
    document.getElementById('installBanner').style.display = 'none';
  }
  _deferredInstallPrompt = null;
});

window.addEventListener('appinstalled', () => {
  document.getElementById('installBanner').style.display = 'none';
  showToast('ğŸ‰ å¾‹å¸«è¨ˆæ™‚ App å®‰è£æˆåŠŸï¼');
});

function dismissInstall() {
  document.getElementById('installBanner').style.display = 'none';
  localStorage.setItem('installDismissed', 'true');
}

/* ============================================================
   PWAï¼šiOS Safari å®‰è£æç¤º
   ============================================================ */
(function checkiOSInstall() {
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isInStandalone = window.navigator.standalone === true;
  const dismissed = localStorage.getItem('iosBannerDismissed') === 'true';
  if (isIOS && !isInStandalone && !dismissed) {
    // å»¶é² 2 ç§’å†é¡¯ç¤ºï¼Œé¿å…é é¢å‰›è¼‰å…¥å°±è¢«æ©«å¹…é®è“‹
    setTimeout(() => {
      document.getElementById('iosBanner').style.display = 'block';
      localStorage.setItem('iosBannerDismissed', 'true'); // åªé¡¯ç¤ºä¸€æ¬¡
    }, 2000);
  }
})();

/* ============================================================
   PWAï¼šé›¢ç·š / ä¸Šç·šåµæ¸¬
   ============================================================ */
function updateOnlineStatus() {
  const banner = document.getElementById('offlineBanner');
  if (!navigator.onLine) {
    banner.style.display = 'block';
  } else {
    banner.style.display = 'none';
  }
}
window.addEventListener('online',  updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus(); // åˆå§‹æª¢æŸ¥

/* ============================================================
   å•Ÿå‹•
   ============================================================ */
init();
</script>
</body>
</html>
